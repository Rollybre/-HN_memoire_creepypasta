library(syuzhet)

# Fonction pour diviser un texte en parties
split_text_into_n_parts <- function(text, n) {
  total_length <- nchar(text)
  part_length <- total_length %/% n
  extra_chars <- total_length %% n
  parts <- vector("character", n)
  start_index <- 1
  
  for (i in 1:n) {
    current_part_length <- part_length + ifelse(i <= extra_chars, 1, 0)
    parts[i] <- substr(text, start_index, start_index + current_part_length - 1)
    start_index <- start_index + current_part_length
  }
  
  return(parts)
}

# Fonction pour analyser le sentiment d'un texte
analyze_sentiment <- function(text) {
  chunked <- split_text_into_n_parts(text, 100)
  sentiments <- get_sentiment(chunked, method="bing")
  sentiments_tr <-get_dct_transform(sentiments)
  return(sentiments_tr)
}


# Chemin vers le dossier contenant les fichiers texte
dossier <- "../17.04_txt/reddit_no_sleep/"

# Liste des fichiers texte dans le dossier
fichiers <- list.files(dossier, pattern = "\\.txt$", full.names = TRUE)

# Initialisation d'une liste pour stocker les résultats de sentiment pour chaque fichier
resultats_sentiment <- list()

# Analyse du sentiment pour chaque fichier
library(progress)

pb <- progress_bar$new(format = "[:bar] :percent :eta", total = length(fichiers))

# Boucle sur chaque fichier
for (fichier in fichiers) {
  texte <- readLines(fichier)
  texte <- paste(texte, collapse=' ')
  
  # Analyse du sentiment
  resultats_sentiment[[fichier]] <- analyze_sentiment(texte)
  
  # Mettre à jour la barre de progression
  pb$tick()
}

# Finaliser la barre de progression
pb$close()

# Normalisation des valeurs de sentiment
max_sentiment <- max(unlist(lapply(resultats_sentiment, max)))
min_sentiment <- min(unlist(lapply(resultats_sentiment, min)))

# Tracé des graphiques
par(mfrow=c(1,1)) # Ajustement de la disposition des graphiques
colors <- rainbow(length(resultats_sentiment)) # Couleurs pour les différentes courbes
legend_names <- c() # Initialisation pour stocker les noms des fichiers pour la légende


plot(NULL, xlim = c(1, 100), ylim = c(0, 1), 
     type = "l", main = "Analyse de sentiment", 
     xlab = "Narrative Time", ylab = "Emotional Valence")

resultats_sentiment_tr<-list()

for (i in 1:length(resultats_sentiment)) {
  tr_sentiment <- get_dct_transform(resultats_sentiment[[i]])
  tr_sentiment <- scale(tr_sentiment, center = min_sentiment, scale = max_sentiment - min_sentiment)
  resultats_sentiment_tr[[i]] <- tr_sentiment
  x <- 1:length(tr_sentiment)
  lines(x, tr_sentiment, col = colors[i])
  legend_names <- c(legend_names, basename(names(resultats_sentiment)[i]))
}

legend("topright", legend = legend_names, col = colors, lty = 1, cex = 0.8) # Ajouter une légende



# Calcul des distances euclidiennes entre chaque paire de vecteurs
distances <- dist(do.call(rbind, resultats_sentiment))

# Convertir les distances en une matrice carrée
dist_matrix <- as.matrix(distances)

# Tracez un histogramme des distances ou un graphique de densité
plot(density(distances))

